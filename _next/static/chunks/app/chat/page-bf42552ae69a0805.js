(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[457],{4627:(e,t,a)=>{Promise.resolve().then(a.bind(a,4926))},4926:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>p});var r=a(8045),s=a(5177),l=a(894),d=a.n(l),n=a(1636),o=a(7053),i=a(1736),c=a(556),m=a(8453),u=a(9739),g=a(1252),x=a(5912),b=a(4008);let h="chat.conversations.v1";function p(){var e;let[t,a]=(0,s.useState)([]),[l,p]=(0,s.useState)(""),[f,v]=(0,s.useState)(""),[y,k]=(0,s.useState)([]),[j,w]=(0,s.useState)(""),[N,A]=(0,s.useState)(""),[D,C]=(0,s.useState)(!1),z=(0,s.useRef)(null),S=(0,s.useRef)(null),[U,E]=(0,s.useState)([]),I=(0,s.useRef)(null);(0,s.useEffect)(()=>{let e=function(){try{let e=localStorage.getItem(h);if(!e)return[];let t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return[]}}();k(e),fetch("/api/models").then(e=>e.json()).then(t=>{let r=Array.isArray(null==t?void 0:t.models)?t.models:[];a(r);let s="string"==typeof(null==t?void 0:t.default)&&t.default?t.default:r[0]||"gpt-4o-mini";if(p(s),v(s),0===e.length){let e={id:crypto.randomUUID(),title:"新对话",model:s,messages:[],updatedAt:Date.now()};k([e]),w(e.id)}else w(e[0].id)}).catch(()=>{let e="gpt-4o-mini";if(a([e]),p(e),v(e),0===y.length){let t={id:crypto.randomUUID(),title:"新对话",model:e,messages:[],updatedAt:Date.now()};k([t]),w(t.id)}else w(y[0].id)})},[]),(0,s.useEffect)(()=>{y.length>0&&function(e){try{localStorage.setItem(h,JSON.stringify(e))}catch(e){}}(y)},[y]);let M=(0,s.useMemo)(()=>y.find(e=>e.id===j),[y,j]);function O(e){let t=e||f||l||"gpt-4o-mini",a={id:crypto.randomUUID(),title:"新对话",model:t,messages:[],updatedAt:Date.now()};k(e=>[a,...e]),w(a.id)}async function H(){if(!M)return;let e=N.trim();if(!e)return;async function t(e){if(e.type.startsWith("image/")&&e.size<=1048576){let t=await new Promise(t=>{let a=new FileReader;a.onload=()=>t(String(a.result||"")),a.readAsDataURL(e)});return{name:e.name,type:e.type,size:e.size,dataUrl:t}}return{name:e.name,type:e.type,size:e.size}}A("");let a=await Promise.all(U.map(t)).catch(()=>[]);E([]);let r={id:crypto.randomUUID(),role:"user",content:e,createdAt:Date.now(),attachments:a};k(e=>e.map(e=>e.id===M.id?{...e,messages:[...e.messages,r],updatedAt:Date.now()}:e)),C(!0);try{var s,d,n,o,i,c,m;let t=new AbortController;S.current=t;let r=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:M.model||f||l,messages:[...M.messages.map(e=>({role:e.role,content:e.content})),{role:"user",content:a&&a.length>0?"".concat(e,"\n\n[附件]\n").concat(a.map(e=>"- ".concat(e.name," (").concat(Math.round(e.size/1024),"KB, ").concat(e.type||"unknown",")")).join("\n")):e}],stream:!0}),signal:t.signal});if(!r.ok){let e=await r.text().catch(()=>"");throw Error(e||"请求失败")}let u=crypto.randomUUID();k(e=>e.map(e=>e.id===M.id?{...e,messages:[...e.messages,{id:u,role:"assistant",content:"",createdAt:Date.now()}],updatedAt:Date.now()}:e));let g=null==(s=r.body)?void 0:s.getReader(),x=new TextDecoder,b="";for(;g;){let{value:e,done:t}=await g.read();if(t)break;let a=(b+=x.decode(e,{stream:!0})).split("\n\n");for(let e of(b=a.pop()||"",a))for(let t of e.split("\n")){let e=t.trim();if(!e.startsWith("data:"))continue;let a=e.slice(5).trim();if(a&&"[DONE]"!==a)try{let e=JSON.parse(a),t=(null==e||null==(o=e.choices)||null==(n=o[0])||null==(d=n.delta)?void 0:d.content)||(null==e||null==(m=e.choices)||null==(c=m[0])||null==(i=c.message)?void 0:i.content)||"";t&&k(e=>e.map(e=>{if(e.id!==M.id)return e;let a=e.messages.map(e=>e.id===u?{...e,content:e.content+t}:e);return{...e,messages:a,updatedAt:Date.now()}}))}catch(e){}}}k(e=>e.map(e=>{if(e.id!==M.id)return e;let t=e.messages.find(e=>"user"===e.role),a="新对话"===e.title&&t?t.content.slice(0,18)+(t.content.length>18?"…":""):e.title;return{...e,title:a,updatedAt:Date.now()}}))}catch(e){if((null==e?void 0:e.name)==="AbortError");else{let t={id:crypto.randomUUID(),role:"assistant",content:"错误：".concat((null==e?void 0:e.message)||e),createdAt:Date.now()};k(e=>e.map(e=>e.id===(null==M?void 0:M.id)?{...e,messages:[...e.messages,t],updatedAt:Date.now()}:e))}}finally{C(!1),S.current=null}}function P(e){v(e),M&&k(t=>t.map(t=>t.id===M.id?{...t,model:e,updatedAt:Date.now()}:t))}async function R(e){try{await navigator.clipboard.writeText(e)}catch(e){}}return(0,s.useEffect)(()=>{var e;null==(e=z.current)||e.scrollTo({top:z.current.scrollHeight})},[null==M||null==(e=M.messages)?void 0:e.length,D]),(0,r.jsxs)("div",{className:"flex gap-4 p-4",children:[(0,r.jsxs)("aside",{className:"w-72 shrink-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md rounded-xl border border-gray-200/50 dark:border-slate-700/50 shadow-lg p-4 h-[75vh] overflow-hidden",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-4",children:[(0,r.jsx)("button",{onClick:()=>O(),className:"px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white transition-all duration-200 shadow-sm font-medium",children:"新建对话"}),(0,r.jsx)("select",{"aria-label":"选择模型",value:(null==M?void 0:M.model)||f,onChange:e=>P(e.target.value),className:"flex-1 h-10 rounded-lg border border-gray-200/80 dark:border-slate-600/50 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm px-2 text-sm",children:t.map(e=>(0,r.jsx)("option",{value:e,children:e},e))})]}),(0,r.jsx)("div",{className:"h-[calc(75vh-60px)] overflow-auto pr-1 space-y-2",children:y.map(e=>(0,r.jsxs)("div",{className:"group rounded-lg border p-3 cursor-pointer transition-all duration-200 ".concat(e.id===j?"border-blue-400 bg-blue-50/80 dark:bg-slate-800/60 shadow-md":"border-gray-200/60 dark:border-slate-700/40 bg-white/60 dark:bg-slate-900/40 hover:bg-gray-50/80 dark:hover:bg-slate-800/50"),onClick:()=>w(e.id),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,r.jsx)("input",{className:"flex-1 bg-transparent outline-none text-sm",value:e.title,onChange:t=>{var a,r;return a=e.id,r=t.target.value,void k(e=>e.map(e=>e.id===a?{...e,title:r,updatedAt:Date.now()}:e))},placeholder:"对话标题","aria-label":"对话标题"}),(0,r.jsx)("button",{onClick:t=>{t.stopPropagation();var a=e.id;if(k(e=>e.filter(e=>e.id!==a)),j===a){let e=y.filter(e=>e.id!==a);e[0]?w(e[0].id):O()}},className:"opacity-0 group-hover:opacity-100 text-slate-400 hover:text-red-500 transition-all duration-200 text-xs bg-gray-100/80 dark:bg-slate-700/80 px-2 py-1 rounded",children:"删除"})]}),(0,r.jsxs)("div",{className:"text-xs text-slate-500 dark:text-slate-400 mt-2 flex items-center gap-2",children:[(0,r.jsx)("span",{className:"bg-gray-100 dark:bg-slate-700 px-2 py-0.5 rounded text-xs font-mono",children:e.model}),(0,r.jsx)("span",{children:d()(e.updatedAt).format("MM-DD HH:mm")})]})]},e.id))})]}),(0,r.jsxs)("section",{className:"flex-1 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md rounded-xl border border-gray-200/50 dark:border-slate-700/50 shadow-lg p-4 flex flex-col h-[75vh]",children:[(0,r.jsxs)("div",{className:"mb-4 flex items-center gap-2 pb-3 border-b border-gray-200/50 dark:border-slate-700/50",children:[(0,r.jsx)("div",{className:"text-sm text-slate-600 dark:text-slate-400 font-medium",children:"当前模型："}),(0,r.jsx)("select",{"aria-label":"切换当前对话模型",value:(null==M?void 0:M.model)||f,onChange:e=>P(e.target.value),className:"h-9 rounded-lg border border-gray-200/80 dark:border-slate-600/50 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm px-2 text-sm",children:t.map(e=>(0,r.jsx)("option",{value:e,children:e},e))}),(0,r.jsx)("div",{className:"flex-1"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsxs)("button",{onClick:()=>O(),className:"h-9 px-3 rounded-lg border border-gray-200/80 dark:border-slate-600/50 bg-white/60 dark:bg-slate-800/60 hover:bg-white dark:hover:bg-slate-800 flex items-center gap-1 transition-all duration-200 text-sm font-medium",children:[(0,r.jsx)(i.A,{})," 新建"]}),(0,r.jsxs)("button",{onClick:function(){M&&k(e=>e.map(e=>e.id===M.id?{...e,messages:[],title:"新对话",updatedAt:Date.now()}:e))},className:"h-9 px-3 rounded-lg border border-gray-200/80 dark:border-slate-600/50 bg-white/60 dark:bg-slate-800/60 hover:bg-white dark:hover:bg-slate-800 flex items-center gap-1 transition-all duration-200 text-sm font-medium",children:[(0,r.jsx)(c.A,{})," 清空"]}),(0,r.jsxs)("button",{onClick:function(){if(!M)return;let e=M.messages;for(let t=e.length-1;t>=0;t--)if("user"===e[t].role){k(e=>e.map(e=>{if(e.id!==M.id)return e;let t=[...e.messages];return t.length>0&&"assistant"===t[t.length-1].role&&t.pop(),{...e,messages:t}})),A(e[t].content),setTimeout(()=>{H()},0);break}},disabled:D,className:"h-9 px-3 rounded-lg border border-gray-200/80 dark:border-slate-600/50 bg-white/60 dark:bg-slate-800/60 hover:bg-white dark:hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1 transition-all duration-200 text-sm font-medium",children:[(0,r.jsx)(m.A,{})," 重试"]}),(0,r.jsxs)("button",{onClick:()=>{var e;null==(e=S.current)||e.abort()},disabled:!D,className:"h-9 px-3 rounded-lg border border-red-200/80 dark:border-red-700/50 bg-red-50/60 dark:bg-red-900/20 hover:bg-red-100/80 dark:hover:bg-red-900/40 text-red-600 dark:text-red-400 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1 transition-all duration-200 text-sm font-medium",children:[(0,r.jsx)(u.A,{})," 停止"]})]})]}),(0,r.jsxs)("div",{ref:z,className:"flex-1 overflow-auto space-y-4 pr-1 py-2",children:[M&&0!==M.messages.length?M.messages.map(e=>(0,r.jsxs)("div",{className:"flex ".concat("user"===e.role?"justify-end":"justify-start"," items-start gap-2"),children:["user"!==e.role&&(0,r.jsx)("img",{src:"https://picgo-elaina.oss-cn-chengdu.aliyuncs.com/typora/202509091206701.png",alt:"AI",className:"w-8 h-8 rounded-full select-none","data-no-zoom":!0}),(0,r.jsxs)("div",{title:d()(e.createdAt).format("YYYY-MM-DD HH:mm:ss"),className:"max-w-[80%] rounded-xl p-4 border relative shadow-sm ".concat("user"===e.role?"bg-blue-50/80 border-blue-200/50 dark:bg-blue-900/20 dark:border-blue-800/30":"bg-gray-50/80 border-gray-200/50 dark:bg-slate-800/60 dark:border-slate-700/50"),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs px-2 py-1 rounded-full font-medium ".concat("user"===e.role?"bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300":"bg-gray-100 text-gray-700 dark:bg-slate-700 dark:text-slate-300"),children:"user"===e.role?"我":"助手"}),(0,r.jsx)("span",{className:"text-xs text-slate-500 dark:text-slate-400",children:d()(e.createdAt).format("HH:mm:ss")})]}),(0,r.jsxs)("button",{onClick:()=>R(e.content),className:"text-xs text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 flex items-center gap-1 opacity-70 hover:opacity-100 transition-all duration-200 bg-white/50 dark:bg-slate-700/50 px-2 py-1 rounded",children:[(0,r.jsx)(g.A,{})," 复制"]})]}),e.attachments&&e.attachments.length>0&&(0,r.jsx)("div",{className:"mb-2 grid grid-cols-3 gap-2",children:e.attachments.map((e,t)=>e.dataUrl&&e.type.startsWith("image/")?(0,r.jsx)("img",{src:e.dataUrl,alt:e.name,className:"max-h-40 rounded-lg border border-zinc-200 dark:border-zinc-700","data-no-zoom":!0},t):(0,r.jsxs)("div",{className:"text-xs text-zinc-500 border border-dashed border-zinc-300 dark:border-zinc-700 rounded px-2 py-1",children:[e.name," \xb7 ",Math.round(e.size/1024),"KB"]},t))}),(0,r.jsx)("div",{className:"prose prose-zinc dark:prose-invert max-w-none",children:(0,r.jsx)(n.oz,{remarkPlugins:[o.A],components:{code:e=>{let{inline:t,className:a,children:s}=e,l=!t&&"string"==typeof a&&a.startsWith("language-"),d=String(null!=s?s:"");return l?(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("pre",{className:"string"==typeof a?a:void 0,children:(0,r.jsx)("code",{children:d})}),(0,r.jsx)("button",{onClick:()=>R(d),className:"absolute top-2 right-2 text-xs bg-zinc-700/80 hover:bg-zinc-600 text-white px-2 py-1 rounded-md",children:"复制代码"})]}):(0,r.jsx)("code",{className:a,children:s})}},children:e.content})})]}),"user"===e.role&&(0,r.jsx)("img",{src:"https://picgo-elaina.oss-cn-chengdu.aliyuncs.com/typora/202507280819318.jpg",alt:"我",className:"w-8 h-8 rounded-full select-none","data-no-zoom":!0})]},e.id)):(0,r.jsxs)("div",{className:"h-full flex flex-col items-center justify-center text-slate-500 dark:text-slate-400",children:[(0,r.jsx)("div",{className:"text-6xl mb-4 opacity-60",children:"\uD83D\uDCAC"}),(0,r.jsx)("div",{className:"text-lg font-medium",children:"开始你的对话吧"}),(0,r.jsx)("div",{className:"text-sm mt-1 opacity-80",children:"选择一个模型，输入你的问题"})]}),D&&(0,r.jsxs)("div",{className:"flex justify-start items-start gap-2",children:[(0,r.jsx)("img",{src:"https://picgo-elaina.oss-cn-chengdu.aliyuncs.com/typora/202509091206701.png",alt:"AI",className:"w-8 h-8 rounded-full select-none","data-no-zoom":!0}),(0,r.jsx)("div",{className:"bg-gray-50/80 border-gray-200/50 dark:bg-slate-800/60 dark:border-slate-700/50 rounded-xl px-4 py-3 text-sm text-slate-600 dark:text-slate-400 border shadow-sm",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("div",{className:"animate-spin w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full"}),"正在思考…"]})})]})]}),(0,r.jsxs)("div",{className:"mt-3 flex items-end gap-2",children:[U.length>0&&(0,r.jsxs)("div",{className:"absolute -mt-28 w-[calc(100%-2rem)] bg-white/90 dark:bg-slate-900/90 border border-gray-200/50 dark:border-slate-700/50 rounded-xl p-3 backdrop-blur-md shadow-lg",children:[(0,r.jsx)("div",{className:"text-xs text-slate-600 dark:text-slate-400 mb-2 font-medium",children:"待发送的附件："}),(0,r.jsx)("div",{className:"flex flex-wrap gap-2 max-h-40 overflow-auto",children:U.map((e,t)=>(0,r.jsxs)("div",{className:"flex items-center gap-2 border border-dashed border-gray-300/80 dark:border-slate-600/50 rounded-lg px-3 py-2 text-xs bg-gray-50/50 dark:bg-slate-800/30",children:[(0,r.jsx)("span",{className:"truncate max-w-52 font-medium",title:e.name,children:e.name}),(0,r.jsxs)("span",{className:"text-slate-500 dark:text-slate-400",children:[Math.round(e.size/1024),"KB"]}),(0,r.jsx)("button",{onClick:()=>{E(e=>e.filter((e,a)=>a!==t))},className:"text-slate-400 hover:text-red-500 transition-colors px-1 py-0.5 rounded hover:bg-red-50 dark:hover:bg-red-900/20",children:"\xd7"})]},t))})]}),(0,r.jsx)("textarea",{value:N,onChange:e=>A(e.target.value),onKeyDown:e=>{"Enter"===e.key&&!e.shiftKey&&(e.preventDefault(),D||H())},rows:3,placeholder:"输入消息，Enter 发送，Shift+Enter 换行",className:"flex-1 rounded-xl border border-gray-200/80 dark:border-slate-600/50 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm p-3 outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-400 dark:focus:border-blue-500 transition-all duration-200 resize-none"}),(0,r.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,r.jsxs)("button",{onClick:function(){var e;null==(e=I.current)||e.click()},title:"上传图片/文件",className:"px-3 h-11 rounded-xl border border-gray-200/80 dark:border-slate-600/50 bg-white/60 dark:bg-slate-800/60 hover:bg-white dark:hover:bg-slate-800 flex items-center gap-1 transition-all duration-200 text-sm font-medium",children:[(0,r.jsx)(x.A,{})," 上传"]}),(0,r.jsxs)("button",{disabled:D||!N.trim(),onClick:H,className:"px-4 h-11 rounded-xl bg-blue-600 hover:bg-blue-500 text-white disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1 transition-all duration-200 shadow-sm font-medium",children:[(0,r.jsx)(b.A,{})," ",D?"发送中…":"发送"]})]}),(0,r.jsx)("input",{ref:I,onChange:function(e){let t=Array.from(e.target.files||[]);t.length>0&&E(e=>[...e,...t]),e.target.value=""},type:"file",multiple:!0,hidden:!0})]})]})]})}}},e=>{e.O(0,[639,448,986,143,358],()=>e(e.s=4627)),_N_E=e.O()}]);